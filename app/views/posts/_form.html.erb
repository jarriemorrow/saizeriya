<%= form_with(model: @post, local: true) do |f| %>
  <div class="field">
    <%= f.label :recipe_name, "レシピ名" %><br>
    <%= f.text_field :recipe_name %>
  </div>
  <div class="field">
    <%= f.label :body, "コメント" %><br>
    <%= f.text_area :body %>
  </div>

  <div class="form-group">
    <div id="tag-fields-container">
      <%= f.label :tag_ids, "メニュー種類"%><br>
      <%= f.collection_radio_buttons :tag_ids, Tag.all, :id, :name, {}, { multiple: true, class: "form-control" } %>
    </div>
  </div>

  <div class="form-group" id="menu-fields-container">
    <% @post.menus.each_with_index do |menu, index| %>
      <div class="menu-field">
      <% if index == 0 %>
        <%= f.label :menu_ids, "メニュー" %><br>
      <% end %>
        <%= f.collection_select :menu_ids, Menu.all, :id, :menu_name, { selected: menu.id }, { multiple: false, class: "form-control", name: "post[menu_ids][]", id: "post_menu_ids_#{index}" } %>
        <a href="#" class="remove-menu-field btn btn-danger">削除</a>
      </div>
    <% end %>
    <%= link_to 'メニューを追加',"", id: "add-menu-field", class: "btn btn-secondary", data: {turbo:false}%>
  </div>

  <div class="actions">
    <%= f.submit %>
  </div>
<% end %>
<%= javascript_tag do %>
  document.addEventListener("DOMContentLoaded", () => {
    const addMenuButton = document.getElementById("add-menu-field");
    const menuFieldsContainer = document.getElementById("menu-fields-container");
    let menuFieldIndex = document.querySelectorAll('.menu-field').length;

    addMenuButton.addEventListener("click", (event) => {
      event.preventDefault();
      const newMenuField = createMenuField(menuFieldIndex);
      menuFieldsContainer.insertBefore(newMenuField, addMenuButton);
      menuFieldIndex++;
    });

    menuFieldsContainer.addEventListener("click", (event) => {
      if (event.target.classList.contains("remove-menu-field")) {
        event.preventDefault();
        event.target.closest(".menu-field").remove();
      }
    });

    function createMenuField(index) {
      const menuField = document.createElement("div");
      menuField.classList.add("menu-field");
      menuField.innerHTML = `
        <select name="post[menu_ids][]" id="post_menu_ids_${index}" class="form-control">
          <%= options_from_collection_for_select(Menu.all, :id, :menu_name) %>
        </select>
        <a href="#" class="remove-menu-field btn btn-danger">削除</a>
      `;
      return menuField;
    }
  });
<% end %>
